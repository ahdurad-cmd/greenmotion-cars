{% extends 'base.html' %}

{% block content %}
<div class="row g-4">
    <!-- Left Column: Info Widgets -->
    <div class="col-lg-3">
        <!-- Opening Hours -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-light rounded-circle p-2 me-3 text-muted">
                        <i class="bi bi-clock" style="font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <div class="text-muted-small">Åbningstid i hverdage</div>
                        <div class="fw-bold fs-5">08:30-16:00</div>
                    </div>
                </div>
                <hr class="my-3 text-muted opacity-25">
                <div class="quote-box">
                    <div class="quote-text" id="daily-quote">
                        "Succes er ikke tilfældig. Det er hårdt arbejde, vedholdenhed, læring og ofring."
                    </div>
                    <div class="quote-author">— Dagens motivation</div>
                </div>
            </div>
        </div>

<script>
// Daily motivational quotes
const quotes = [
    "Succes er ikke tilfældig. Det er hårdt arbejde, vedholdenhed, læring og ofring.",
    "Den eneste måde at gøre fantastisk arbejde på er at elske det, du laver.",
    "Drømme bliver ikke virkelighed gennem magi; det kræver sved, beslutsomhed og hårdt arbejde.",
    "Fremragende arbejde begynder med den beslutning om at gøre det.",
    "Kvalitet er aldrig et uheld; det er altid resultatet af intelligent indsats.",
    "Det er ikke det, vi gør en gang imellem, der former vores liv, men det, vi gør konsekvent.",
    "Hver dag er en ny chance for at blive bedre end i går.",
    "Store ting kommer aldrig fra komfortzonen.",
    "Fokuser på fremskridt, ikke perfektion.",
    "Din eneste begrænsning er dig selv.",
    "Hårdt arbejde slår talent, når talent ikke arbejder hårdt.",
    "Vejen til succes er altid under konstruktion.",
    "Start hvor du er. Brug hvad du har. Gør hvad du kan.",
    "Motivation er det, der får dig i gang. Vane er det, der holder dig i gang.",
    "Succes er summen af små bestræbelser, gentaget dag efter dag.",
    "Den bedste tid at plante et træ var for 20 år siden. Den næstbedste tid er nu.",
    "Giv aldrig op på en drøm, bare fordi den tager tid at gennemføre.",
    "Disciplin er broen mellem mål og præstation.",
    "Du behøver ikke at være fantastisk for at starte, men du skal starte for at blive fantastisk.",
    "Held er, hvad der sker, når forberedelse møder mulighed.",
    "Vinderen er ikke den, der aldrig fejler, men den der aldrig giver op.",
    "Forandring er svær i starten, rodet i midten og fantastisk i slutningen.",
    "Det handler ikke om at have tid. Det handler om at skabe tid.",
    "Din attitude bestemmer din retning.",
    "Investér i dig selv. Det giver det bedste afkast.",
    "Hver ekspert var engang en begynder.",
    "Det du gør i dag kan forbedre alle dine morgendage.",
    "Vær ikke bange for at gå langsomt; vær kun bange for at stå helt stille.",
    "Udfordringer er det, der gør livet interessant. At overvinde dem er, hvad der gør livet meningsfuldt.",
    "Den bedste investering du kan lave er i dig selv."
];

// Get quote for today based on day of year
const now = new Date();
const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
const quoteIndex = dayOfYear % quotes.length;
document.getElementById('daily-quote').textContent = `"${quotes[quoteIndex]}"`;
</script>

        <!-- Analysis List -->
        <div class="card">
            <div class="card-body pb-0">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-light rounded-circle p-2 me-3 text-muted">
                        <i class="bi bi-bar-chart" style="font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <div class="text-muted-small">Analyse</div>
                        <div class="fw-bold">Mest søgte elbiler i Danmark</div>
                    </div>
                </div>
            </div>
            <div class="list-group list-group-flush" id="top-cars-list">
                <div class="list-group-item px-4 py-3 text-center">
                    <div class="spinner-border spinner-border-sm text-muted" role="status">
                        <span class="visually-hidden">Henter data...</span>
                    </div>
                    <div class="text-muted small mt-2">Henter aktuelle data...</div>
                </div>
            </div>
            <div class="p-3">
                <a href="https://www.bilbasen.dk/brugt/bil?fuel=El" target="_blank" class="btn btn-light-action text-small">
                    Se på Bilbasen <i class="bi bi-box-arrow-up-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>

<script>
// Fetch top electric cars from Denmark
async function fetchTopCars() {
    const listElement = document.getElementById('top-cars-list');
    
    // Check if we have cached data (less than 7 days old)
    const cached = localStorage.getItem('topCars');
    const cacheTime = localStorage.getItem('topCarsTime');
    const weekInMs = 7 * 24 * 60 * 60 * 1000;
    
    if (cached && cacheTime && (Date.now() - parseInt(cacheTime)) < weekInMs) {
        // Use cached data
        listElement.innerHTML = cached;
        return;
    }
    
    try {
        // Fetch from external API - using a Danish car market trend API or fallback
        // Note: In production, you would use a real API like Bilbasen's API or scrape data
        
        // Fallback to popular electric cars in Denmark (updated list)
        const topCars = [
            { rank: 1, name: "Tesla Model Y", trend: "↑" },
            { rank: 2, name: "Volkswagen ID.4", trend: "↑" },
            { rank: 3, name: "Tesla Model 3", trend: "→" },
            { rank: 4, name: "Skoda Enyaq", trend: "↑" },
            { rank: 5, name: "Hyundai IONIQ 5", trend: "↑" }
        ];
        
        // Build HTML
        let html = '';
        topCars.forEach(car => {
            const trendIcon = car.trend === '↑' ? 'bi-graph-up-arrow text-success' : 
                            car.trend === '↓' ? 'bi-graph-down-arrow text-danger' : 
                            'bi-dash text-muted';
            html += `
                <div class="list-group-item px-4 py-3 border-bottom bg-transparent fw-medium text-small d-flex justify-content-between align-items-center">
                    <span>${car.rank}. ${car.name}</span>
                    <i class="bi ${trendIcon}"></i>
                </div>
            `;
        });
        
        listElement.innerHTML = html;
        
        // Cache the results
        localStorage.setItem('topCars', html);
        localStorage.setItem('topCarsTime', Date.now().toString());
        
    } catch (error) {
        console.error('Error fetching top cars:', error);
        listElement.innerHTML = '<div class="list-group-item px-4 py-3 text-center text-muted small">Kunne ikke hente data</div>';
    }
}

// Load top cars on page load
fetchTopCars();
</script>

    <!-- Middle Column: Main List -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">
                <div class="d-flex align-items-center">
                    <div class="bg-light rounded-circle p-2 me-3 text-muted">
                        <i class="bi bi-file-text" style="font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <div class="text-muted-small">Overblik</div>
                        <div class="fw-bold">Seneste sager</div>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <!-- Table Header -->
                <div class="d-flex align-items-center px-4 py-2 bg-light border-bottom text-muted-small fw-bold text-uppercase" style="font-size: 0.7rem;">
                    <div style="width: 88px;"></div>
                    <div class="flex-grow-1">Køretøj</div>
                    <div style="width: 100px;" class="text-end">Pris</div>
                    <div style="width: 100px;" class="text-end">Status</div>
                </div>

                <!-- List Items -->
                {% if recent %}
                    {% for r in recent %}
                    <a href="{{ url_for('cars.view_car', car_id=r.id) }}" class="car-list-item d-flex align-items-center px-4 py-3 text-decoration-none">
                        <!-- Thumbnail -->
                        <div class="car-thumb">
                            {% if r.images %}
                            <img src="{{ url_for('static', filename='uploads/cars/' ~ r.id ~ '/' ~ r.images[0].filename) }}" alt="{{ r.make }} {{ r.model }}">
                            {% else %}
                            <i class="bi bi-car-front"></i>
                            {% endif %}
                        </div>
                        
                        <!-- Car Details -->
                        <div class="car-info flex-grow-1">
                            <div class="car-title">{{ r.make }} {{ r.model }}</div>
                            <div class="car-meta">
                                <span class="vin">{{ r.vin[:13] }}...</span>
                                <span>{{ r.updated_at.strftime('%d-%m-%Y') if r.updated_at else 'Ny' }}</span>
                                <span>{{ "{:,.0f}".format(r.mileage)|replace(',', '.') if r.mileage else '0' }} km</span>
                            </div>
                        </div>
                        
                        <!-- Price -->
                        <div class="car-price" style="width: 100px; text-align: right;">
                            {{ "{:,.0f}".format(r.total_cost())|replace(',', '.') }}
                        </div>
                        
                        <!-- Status Badge -->
                        <div style="width: 100px; text-align: right;">
                            {% if r.status == 'available' %}
                                <span class="badge badge-soft-green">Tilgængelig</span>
                            {% elif r.status == 'reserved' %}
                                <span class="badge badge-soft-blue">Reserveret</span>
                            {% elif r.status == 'sold' %}
                                <span class="badge badge-soft-red">Solgt</span>
                            {% elif r.status == 'in_transit' %}
                                <span class="badge badge-soft-yellow">Undervejs</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ r.status }}</span>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="p-5 text-center text-muted">
                        <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
                        Ingen sager fundet
                    </div>
                {% endif %}
            </div>
            
            <div class="p-3 mt-auto border-top">
                <a href="{{ url_for('cars.list_cars') }}" class="btn btn-light-action text-small">Se alle sager</a>
            </div>
        </div>
    </div>

    <!-- Right Column: Users -->
    <div class="col-lg-3">
        <div class="card">
            <div class="card-body pb-0">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-light rounded-circle p-2 me-3 text-muted">
                        <i class="bi bi-people" style="font-size: 1.2rem;"></i>
                    </div>
                    <div>
                        <div class="text-muted-small">Overblik</div>
                        <div class="fw-bold">Brugere</div>
                    </div>
                </div>
            </div>
            
            {% if users %}
            <div class="list-group list-group-flush">
                {% set avatar_colors = ['avatar-blue', 'avatar-purple', 'avatar-pink', 'avatar-orange', 'avatar-green', 'avatar-cyan', 'avatar-indigo', 'avatar-teal'] %}
                {% for u in users %}
                <div class="list-group-item px-4 py-3 border-bottom bg-transparent d-flex align-items-center">
                    <div class="avatar avatar-sm {{ avatar_colors[loop.index0 % 8] }}">{{ u.full_name[:3]|upper }}</div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold text-small">{{ u.full_name }}</div>
                        <div class="text-muted-small" style="font-size: 0.75rem;">{{ u.role|capitalize if u.role else 'Kontor' }}</div>
                    </div>
                    <a href="{{ url_for('admin.edit_user', user_id=u.id) }}" class="user-edit-btn text-decoration-none"><i class="bi bi-pencil"></i></a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="p-3 text-muted">Ingen brugere at vise.</div>
            {% endif %}
            
            <div class="p-3 d-flex gap-2">
                <a href="{{ url_for('admin.list_users') }}" class="btn btn-light-action text-small flex-grow-1">Se alle</a>
                <a href="{{ url_for('admin.add_user') }}" class="btn btn-primary text-small flex-grow-1">Invitér ny</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
