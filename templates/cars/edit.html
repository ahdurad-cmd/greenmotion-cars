{% extends "base.html" %}

{% block title %}Rediger {{ car.make }} {{ car.model }} - GreenMotion Cars{% endblock %}

{% block content %}
<div class="mb-4">
    <h1>Rediger Bil</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('cars.list_cars') }}">Biler</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('cars.view_car', car_id=car.id) }}">{{ car.vin }}</a></li>
            <li class="breadcrumb-item active">Rediger</li>
        </ol>
    </nav>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="{{ url_for('cars.edit_car', car_id=car.id) }}">
            <h5 class="mb-3">Grundlæggende Information</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="vin" class="form-label">VIN-nummer *</label>
                    <input type="text" class="form-control" id="vin" name="vin" required 
                           value="{{ car.vin }}" maxlength="17" style="text-transform: uppercase;">
                    <small class="text-muted">17 tegn</small>
                </div>
                <div class="col-md-3">
                    <label for="make" class="form-label">Mærke *</label>
                    <input type="text" class="form-control" id="make" name="make" required value="{{ car.make }}">
                </div>
                <div class="col-md-3">
                    <label for="model" class="form-label">Model *</label>
                    <input type="text" class="form-control" id="model" name="model" required value="{{ car.model }}">
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-2">
                    <label for="year" class="form-label">Årgang *</label>
                    <input type="number" class="form-control" id="year" name="year" required 
                           min="1990" max="2026" value="{{ car.year }}">
                </div>
                <div class="col-md-3">
                    <label for="color" class="form-label">Farve</label>
                    <input type="text" class="form-control" id="color" name="color" value="{{ car.color or '' }}">
                </div>
                <div class="col-md-4">
                    <label for="mileage" class="form-label">Kilometerstand</label>
                    <input type="number" class="form-control" id="mileage" name="mileage" min="0" value="{{ car.mileage or '' }}">
                </div>
            </div>

            <hr class="my-4">
            <h5 class="mb-3">Import Information</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="import_country" class="form-label">Importland *</label>
                    <select class="form-select" id="import_country" name="import_country" required>
                        <option value="Sverige" {% if car.import_country == 'Sverige' %}selected{% endif %}>Sverige</option>
                        <option value="Tyskland" {% if car.import_country == 'Tyskland' %}selected{% endif %}>Tyskland</option>
                        <option value="Danmark" {% if car.import_country == 'Danmark' %}selected{% endif %}>Danmark</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="supplier" class="form-label">Leverandør</label>
                    <input type="text" class="form-control" id="supplier" name="supplier" value="{{ car.supplier or '' }}">
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="dealer_name" class="form-label">Forhandler</label>
                    <input type="text" class="form-control" id="dealer_name" name="dealer_name" value="{{ car.dealer_name or '' }}">
                </div>
                <div class="col-md-4">
                    <label for="dealer_location" class="form-label">By (lokation)</label>
                    <input type="text" class="form-control" id="dealer_location" name="dealer_location" value="{{ car.dealer_location or '' }}">
                </div>
                <div class="col-md-4">
                    <label for="distance_km" class="form-label">Afstand fra Aalborg (km)</label>
                    <input type="number" class="form-control" id="distance_km" name="distance_km" value="{{ car.distance_km or '' }}" min="0">
                    <small class="text-muted">Transport beregnes automatisk</small>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="import_date" class="form-label">Importdato</label>
                    <input type="date" class="form-control" id="import_date" name="import_date" 
                           value="{{ car.import_date.strftime('%Y-%m-%d') if car.import_date else '' }}">
                </div>
            </div>

            <hr class="my-4">
            <h5 class="mb-3">Omkostninger</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="purchase_price" class="form-label">Købspris (inkl. moms) *</label>
                    <input type="number" class="form-control" id="purchase_price" name="purchase_price" 
                           required step="0.01" min="0" value="{{ car.purchase_price }}">
                    <div class="form-text small text-muted" id="net_price_info" style="{% if car.import_country and (car.import_country.lower() in ['tyskland', 'germany', 'sverige', 'sweden']) %}display:block{% else %}display:none{% endif %}">
                        <i class="bi bi-info-circle me-1"></i>Netto: <span id="net_price_value">{{ "{:,.0f}".format(car.net_purchase_price())|replace(',', '.') }} {{ car.purchase_currency }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="discount" class="form-label">Rabat</label>
                    <input type="number" class="form-control" id="discount" name="discount" 
                           step="0.01" min="0" value="{{ car.discount or 0 }}">
                </div>
                <div class="col-md-3">
                    <label for="transport_cost" class="form-label">Transport</label>
                    <input type="number" class="form-control" id="transport_cost" name="transport_cost" 
                           step="0.01" min="0" value="{{ car.transport_cost or 0 }}">
                </div>
                <div class="col-md-3">
                    <label for="customs_cost" class="form-label">Told</label>
                    <input type="number" class="form-control" id="customs_cost" name="customs_cost" 
                           step="0.01" min="0" value="{{ car.customs_cost or 0 }}">
                </div>
                <div class="col-md-3">
                    <label for="preparation_cost" class="form-label">Klargøring</label>
                    <input type="number" class="form-control" id="preparation_cost" name="preparation_cost" 
                           step="0.01" min="0" value="{{ car.preparation_cost or 0 }}">
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="other_costs" class="form-label">Øvrige</label>
                    <input type="number" class="form-control" id="other_costs" name="other_costs" 
                           step="0.01" min="0" value="{{ car.other_costs or 0 }}">
                </div>
            </div>

            <hr class="my-4">
            <h5 class="mb-3">Priser</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="selling_price" class="form-label">Salgspris</label>
                    <input type="number" class="form-control" id="selling_price" name="selling_price" 
                           step="0.01" min="0" value="{{ car.selling_price or '' }}">
                </div>
                <div class="col-md-3">
                    <label for="dealer_price" class="form-label">Forhandlerpris</label>
                    <input type="number" class="form-control" id="dealer_price" name="dealer_price" 
                           step="0.01" min="0" value="{{ car.dealer_price or '' }}">
                </div>
                <div class="col-md-3">
                    <label for="private_price" class="form-label">Privatpris</label>
                    <input type="number" class="form-control" id="private_price" name="private_price" 
                           step="0.01" min="0" value="{{ car.private_price or '' }}">
                </div>
            </div>

            <hr class="my-4">
            <h5 class="mb-3">Status & Registrering</h5>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="status" class="form-label">Status *</label>
                    <select class="form-select" id="status" name="status" required>
                        <option value="ordered" {% if car.status == 'ordered' %}selected{% endif %}>Bestilt</option>
                        <option value="in_transit" {% if car.status == 'in_transit' %}selected{% endif %}>Undervejs</option>
                        <option value="arrived" {% if car.status == 'arrived' %}selected{% endif %}>Ankommet</option>
                        <option value="in_preparation" {% if car.status == 'in_preparation' %}selected{% endif %}>Under klargøring</option>
                        <option value="available" {% if car.status == 'available' %}selected{% endif %}>Tilgængelig</option>
                        <option value="reserved" {% if car.status == 'reserved' %}selected{% endif %}>Reserveret</option>
                        <option value="sold" {% if car.status == 'sold' %}selected{% endif %}>Solgt</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="registration_number" class="form-label">Registreringsnummer</label>
                    <input type="text" class="form-control" id="registration_number" name="registration_number" 
                           value="{{ car.registration_number or '' }}">
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="equipment" class="form-label">Udstyr</label>
                    <textarea class="form-control" id="equipment" name="equipment" rows="3">{{ car.equipment or '' }}</textarea>
                </div>
                <div class="col-md-6">
                    <label for="condition_notes" class="form-label">Tilstandsnoter</label>
                    <textarea class="form-control" id="condition_notes" name="condition_notes" rows="3">{{ car.condition_notes or '' }}</textarea>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-2"></i>Gem Ændringer
                </button>
                <a href="{{ url_for('cars.view_car', car_id=car.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-2"></i>Annuller
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Calculate net price based on import country and VAT
function calculateNetPrice(){
    const grossPrice = parseFloat(document.getElementById('purchase_price').value||0);
    const discount = parseFloat(document.getElementById('discount').value||0);
    const importCountry = document.getElementById('import_country').value.toLowerCase();
    const currency = document.getElementById('purchase_currency').value || 'DKK';
    
    // Apply discount first
    const priceAfterDiscount = grossPrice - discount;
    
    let vatRate = 0;
    if (importCountry.includes('tyskland') || importCountry.includes('germany')) {
        vatRate = 0.19; // 19% German VAT
    } else if (importCountry.includes('sverige') || importCountry.includes('sweden')) {
        vatRate = 0.25; // 25% Swedish VAT
    }
    
    if (vatRate > 0 && priceAfterDiscount > 0) {
        const netPrice = priceAfterDiscount / (1 + vatRate);
        const formatted = new Intl.NumberFormat('da-DK').format(netPrice) + ' ' + currency;
        document.getElementById('net_price_value').textContent = formatted;
        document.getElementById('net_price_info').style.display = 'block';
    } else {
        document.getElementById('net_price_info').style.display = 'none';
    }
}

// Add listeners for net price calculation
['purchase_price','discount','purchase_currency','import_country'].forEach(id=>{
    const el = document.getElementById(id); 
    if(el){ 
        el.addEventListener('input', calculateNetPrice); 
        el.addEventListener('change', calculateNetPrice); 
    }
});

// Auto-calculate transport cost based on distance (6 DKK/km round trip)
const distanceInput = document.getElementById('distance_km');
const transportInput = document.getElementById('transport_cost');
const customsInput = document.getElementById('customs_cost');
if(distanceInput && transportInput){
    distanceInput.addEventListener('input', function(){
        const km = parseFloat(this.value || 0);
        if(km > 0){
            // Diesel: 13 km/l, diesel price ~12.5 DKK/l
            // Total km = round trip = km * 2
            // Fuel needed = (km * 2) / 13
            // Cost = fuelNeeded * 12.5 DKK
            const totalKm = km * 2;
            const fuelNeeded = totalKm / 13;
            const transportCost = Math.round(fuelNeeded * 12.5);
            transportInput.value = transportCost;
            
            // Customs: 2000 DKK if >= 2000 km, else 1500 DKK
            if(customsInput){
                customsInput.value = km >= 2000 ? 2000 : 1500;
            }
        }
    });
}
</script>
{% endblock %}
