{% extends 'base.html' %}
{% block title %}Salgs Pipeline{% endblock %}

{% block content %}
<div class="container-fluid h-100 d-flex flex-column">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0 fw-bold">Salgs Pipeline</h4>
        <a href="{{ url_for('sales.add_sale') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Nyt Salg
        </a>
    </div>

    <div class="row flex-grow-1 g-3 overflow-auto pb-3" style="min-height: 0;">
        <!-- Lead Column -->
        <div class="col-12 col-md-4 col-xl-2 d-flex flex-column h-100">
            <div class="card h-100 bg-light border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 text-uppercase text-muted small fw-bold">Lead <span class="badge bg-white text-dark border ms-2">{{ leads|length }}</span></h6>
                </div>
                <div class="card-body p-2 overflow-auto kanban-col" data-status="lead">
                    {% for sale in leads %}
                        {% include 'sales/_kanban_card.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Offer Column -->
        <div class="col-12 col-md-4 col-xl-2 d-flex flex-column h-100">
            <div class="card h-100 bg-light border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 text-uppercase text-muted small fw-bold">Tilbud <span class="badge bg-white text-dark border ms-2">{{ offers|length }}</span></h6>
                </div>
                <div class="card-body p-2 overflow-auto kanban-col" data-status="offer_sent">
                    {% for sale in offers %}
                        {% include 'sales/_kanban_card.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Negotiation Column -->
        <div class="col-12 col-md-4 col-xl-2 d-flex flex-column h-100">
            <div class="card h-100 bg-light border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 text-uppercase text-muted small fw-bold">Forhandling <span class="badge bg-white text-dark border ms-2">{{ negotiations|length }}</span></h6>
                </div>
                <div class="card-body p-2 overflow-auto kanban-col" data-status="negotiation">
                    {% for sale in negotiations %}
                        {% include 'sales/_kanban_card.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Contract Column -->
        <div class="col-12 col-md-4 col-xl-2 d-flex flex-column h-100">
            <div class="card h-100 bg-light border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 text-uppercase text-muted small fw-bold">Kontrakt <span class="badge bg-white text-dark border ms-2">{{ contracts|length }}</span></h6>
                </div>
                <div class="card-body p-2 overflow-auto kanban-col" data-status="contract_signed">
                    {% for sale in contracts %}
                        {% include 'sales/_kanban_card.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Pending Column -->
        <div class="col-12 col-md-4 col-xl-2 d-flex flex-column h-100">
            <div class="card h-100 bg-light border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h6 class="mb-0 text-uppercase text-muted small fw-bold">Betaling <span class="badge bg-white text-dark border ms-2">{{ pending|length }}</span></h6>
                </div>
                <div class="card-body p-2 overflow-auto kanban-col" data-status="payment_pending">
                    {% for sale in pending %}
                        {% include 'sales/_kanban_card.html' %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .kanban-card {
        cursor: grab;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kanban-card:active {
        cursor: grabbing;
    }
    .kanban-card.dragging {
        opacity: 0.5;
        transform: scale(0.95);
    }
    .kanban-col.drag-over {
        background-color: rgba(0,0,0,0.05);
        border-radius: 8px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.kanban-card');
    const columns = document.querySelectorAll('.kanban-col');
    let draggedCard = null;

    cards.forEach(card => {
        card.addEventListener('dragstart', () => {
            draggedCard = card;
            card.classList.add('dragging');
        });

        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
            draggedCard = null;
        });
    });

    columns.forEach(col => {
        col.addEventListener('dragover', e => {
            e.preventDefault();
            col.classList.add('drag-over');
        });

        col.addEventListener('dragleave', () => {
            col.classList.remove('drag-over');
        });

        col.addEventListener('drop', async e => {
            e.preventDefault();
            col.classList.remove('drag-over');
            
            if (draggedCard) {
                col.appendChild(draggedCard);
                const saleId = draggedCard.dataset.saleId;
                const newStatus = col.dataset.status;
                
                try {
                    const response = await fetch('/sales/pipeline/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sale_id: saleId,
                            status: newStatus
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Update failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Kunne ikke opdatere status. Pr√∏v igen.');
                    location.reload();
                }
            }
        });
    });
});
</script>
{% endblock %}
